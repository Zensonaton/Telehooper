# coding: utf-8

import asyncio
from typing import cast

from aiogram import Bot, F, Router
from aiogram.filters import (ADMINISTRATOR, CREATOR, JOIN_TRANSITION, KICKED,
                             LEAVE_TRANSITION, MEMBER, RESTRICTED,
                             ChatMemberUpdatedFilter)
from aiogram.types import (CallbackQuery, ChatMemberUpdated,
                           InlineKeyboardButton, InlineKeyboardMarkup, Message,
                           User)
from cachetools import TTLCache
from loguru import logger

import utils
from api import TelehooperAPI
from DB import get_db, get_default_group, get_group
from telegram.bot import get_minibots
from telegram.handlers.this import group_convert_message


_supergroup_converts = []
_minibot_adds: TTLCache[int, list] = TTLCache(100, 60) # –ú–∞–∫—Å–∏–º—É–º 100 —ç–ª–µ–º–µ–Ω—Ç–æ–≤, 60 —Å–µ–∫—É–Ω–¥ —Ö—Ä–∞–Ω–µ–Ω–∏—è.

router = Router()

async def _supergroup_convert_check(chat_id: int) -> bool:
	"""
	–ú–µ—Ç–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ –≥—Ä—É–ø–ø–∞ —Å ID `chat_id` –Ω–µ –±—ã–ª–∞ –Ω–µ–¥–∞–≤–Ω–æ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –≤ supergroup'—É.

	–ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–π –º–µ—Ç–æ–¥ –≤–µ—Ä–Ω—É–ª True, —Ç–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è (—Å–¥–µ–ª–∞—Ç—å `return`).
	"""

	# –ß—Ç–æ –±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –±–æ—Ç —Ç–æ—á–Ω–æ –ø–æ–ª—É—á–∏–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π –≥—Ä—É–ø–ø—ã –≤ —Å—É–ø–µ—Ä–≥—Ä—É–ø–ø—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —á—É—Ç—å-—á—É—Ç—å –ø–æ—Å–ø–∞—Ç—å.
	await asyncio.sleep(1)

	return chat_id in _supergroup_converts

@router.my_chat_member(ChatMemberUpdatedFilter(member_status_changed=JOIN_TRANSITION))
async def on_telehooper_added_in_chat_handler(event: ChatMemberUpdated, bot: Bot) -> None:
	"""
	Handler –¥–ª—è —Å–æ–±—ã—Ç–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É.

	–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–∏ –≥—Ä—É–ø–ø—ã –≤ –≥—Ä—É–ø–ø—É-–¥–∏–∞–ª–æ–≥ –∏ –ø—Ä–æ—á—É—é –ø–æ–ª–µ–∑–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.
	"""

	if event.chat.type == "channel":
		await bot.send_message(
			chat_id=event.chat.id,
			text=(
				"<b>‚ö†Ô∏è –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–∞ –≤ –∫–∞–Ω–∞–ª</b>.\n"
				"\n"
				"–£–ø—Å! –í—ã –¥–æ–±–∞–≤–∏–ª–∏ –±–æ—Ç–∞ Telehooper –≤ <b>–∫–∞–Ω–∞–ª</b>. Telehooper –Ω–µ —É–º–µ–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –∫–∞–Ω–∞–ª–∞—Ö. üôà\n"
				"–°–æ–∑–¥–∞–π—Ç–µ –≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ <b>–≥—Ä—É–ø–ø—É</b> –∏ –¥–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ–≥–æ –±–æ—Ç–∞ –≤ –Ω–µ—ë.\n"
				"\n"
				"‚ÑπÔ∏è Telehooper –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª–∏—Ç —Å–∞–º–æ–≥–æ —Å–µ–±—è –∏–∑ –¥–∞–Ω–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞."
			)
		)

		try:
			await bot.leave_chat(chat_id=event.chat.id)
		except:
			pass

		return

	if await _supergroup_convert_check(event.chat.id):
		return

	# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤ –≥—Ä—É–ø–ø—É –¥–æ–±–∞–≤–∏–ª–∏ –∏–º–µ–Ω–Ω–æ Telehooper.
	if event.new_chat_member.user.id != bot.id:
		return

	status_message = None
	try:
		status_message = await bot.send_message(
			chat_id=event.chat.id,
			text=(
				"<b>ü´Ç –ì—Ä—É–ø–ø–∞-–¥–∏–∞–ª–æ–≥</b>.\n"
				"\n"
				"–ß—Ç–æ –±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å, –í–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ <b>–≤—ã–¥–∞—Ç—å –º–Ω–µ –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</b>. –í—ã–¥–∞–≤ –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –º—ã —Å–º–æ–∂–µ–º –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤—ã–±–æ—Ä –¥–∏–∞–ª–æ–≥–∞.\n"
				"\n"
				"‚ÑπÔ∏è –¢—Ä—É–¥–Ω–æ—Å—Ç–∏ —Å –≤—ã–¥–∞—á–µ–π –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞? –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å, –∫–∞–∫ —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å –¥–ª—è –í–∞—à–µ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã.\n"
				"\n"
				"<i>‚è≥ –î–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤ –±–µ—Å–µ–¥–µ...</i>"
			),
			reply_markup=InlineKeyboardMarkup(inline_keyboard=[[InlineKeyboardButton(text="üëã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –≤—ã–¥–∞—á–µ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞", callback_data="/this showAdminTips")]])
		)
	except:
		# –ú—ã –Ω–µ —Å–º–æ–≥–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä,
		# —É –±–æ—Ç–∞ –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∞ –ª–∏–±–æ –≤ –≥—Ä—É–ø–ø–µ –≤—ã–∫–ª—é—á–µ–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è.
		#
		# –í —Ç–∞–∫–æ–º —Å–ª—É—á–∞–µ, –ø—Ä–æ—Å—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á—Ç–æ –±–æ—Ç —Ç–∞–∫ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ –º–æ–∂–µ—Ç,
		# –∏ —É–¥–∞–ª—è–µ–º—Å—è.

		await bot.send_message(
			chat_id=event.from_user.id,
			text=(
				"<b>‚ö†Ô∏è –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É</b>.\n"
				"\n"
				f"–ü–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ, Telehooper –Ω–µ —Å–º–æ–≥ –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å –≤ –≥—Ä—É–ø–ø–µ ¬´{event.chat.title}¬ª.\n"
				"–í–æ–∑–º–æ–∂–Ω—ã–µ –Ω–∞ —ç—Ç–æ –ø—Ä–∏—á–∏–Ω—ã:\n"
				" ‚Ä¢ –£ –±–æ—Ç–∞ –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤ –≥—Ä—É–ø–ø–µ.\n"
				" ‚Ä¢ –í –≥—Ä—É–ø–ø–µ –æ—Ç–∫–ª—é—á–µ–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è.\n"
				"\n"
				"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–¥–∞—Ç—å –±–æ—Ç—É –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞, –∞ —Ç–∞–∫ –∂–µ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤ –≥—Ä—É–ø–ø–µ –≤–∫–ª—é—á–µ–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è, –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.\n"
				"Telehooper –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∏–Ω–µ—Ç –≥—Ä—É–ø–ø—É –±–µ–∑ –í–∞—à–µ–π –ø–æ–º–æ—â–∏.\n"
				"\n"
				f"‚ÑπÔ∏è –í–æ–∑–Ω–∏–∫–∞—é—Ç –ø—Ä–æ–±–ª–µ–º—ã? –ü–æ–ø—Ä–æ—Å–∏—Ç–µ –ø–æ–º–æ—â–∏ –ª–∏–±–æ —Å–æ–∑–¥–∞–π—Ç–µ –±–∞–≥-—Ä–µ–ø–æ—Ä—Ç (Github Issue), –ø–æ —Å—Å—ã–ª–∫–µ –≤ –∫–æ–º–∞–Ω–¥–µ <a href=\"{utils.create_command_url('/h 6')}\">/help</a>."
			)
		)

		# –£–¥–∞–ª—è–µ–º –±–æ—Ç–∞ –∏–∑ –≥—Ä—É–ø–ø—ã.
		try:
			await bot.leave_chat(chat_id=event.chat.id)
		except:
			pass

		return

	db = await get_db()

	data = get_default_group(
		chat=event.chat,
		creator=event.from_user,
		status_message=status_message,
		topics_enabled=status_message.is_topic_message or False,
		admin_rights=False # TODO: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞?
	)

	# –ù–µ–±–æ–ª—å—à–æ–π –∫–æ—Å—Ç—ã–ª—å –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –≥—Ä—É–ø–ø–∞ —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –ë–î –±–æ—Ç–∞.
	group_db = await db.create(
		f"group_{event.chat.id}",
		exists_ok=True,
		data=data
	)
	group_db.update(data=data)

	await group_db.save()

async def on_minibot_add(user: User) -> None:
	"""
	–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –º–∏–Ω–∏–±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É, –≤ –∫–æ—Ç–æ—Ä–æ–π –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –±–æ—Ç Telehooper.
	"""

	logger.debug(f"–°–æ–±—ã—Ç–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∏–Ω–∏–±–æ—Ç–∞ {utils.get_telegram_logging_info(user)} –≤ –≥—Ä—É–ø–ø—É...")

@router.chat_member(ChatMemberUpdatedFilter(member_status_changed=JOIN_TRANSITION))
async def on_other_member_add_handler(event: ChatMemberUpdated, bot: Bot) -> None:
	"""
	Handler –¥–ª—è —Å–ª—É—á–∞—è, –µ—Å–ª–∏ –≤ –≥—Ä—É–ø–ø—É (–≤ –∫–æ—Ç–æ—Ä–æ–º –Ω–∞—Ö–æ–¥–∏—Ç—Å—è Telehooper) –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω –∫–∞–∫–æ–π-—Ç–æ —Å—Ç–æ—Ä–æ–Ω–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.
	"""

	if await _supergroup_convert_check(event.chat.id):
		return

	group = await get_group(event.chat)

	# –í –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö edge-case'–∞—Ö –≥—Ä—É–ø–ø–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –ë–î.
	if not group:
		return

	# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–æ–≥–æ –∏–º–µ–Ω–Ω–æ –¥–æ–±–∞–≤–∏–ª–∏ –≤ –≥—Ä—É–ø–ø—É. –ú–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ª—É—á–∞–µ–≤:
	#  - 1. –î–æ–±–∞–≤–∏–ª–∏ –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –í —Ç–∞–∫–æ–º —Å–ª—É—á–∞–µ —Å—Ç–æ–∏—Ç –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å
	#       –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –¥–æ–±–∞–≤–ª—è—Ç—å "—Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö" —é–∑–µ—Ä–æ–≤ –Ω–µ —Å—Ç–æ–∏—Ç.
	#  - 2. –î–æ–±–∞–≤–∏–ª–∏ —Å—Ç–æ—Ä–æ–Ω–Ω–µ–≥–æ –±–æ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–∏–Ω–∏–±–æ—Ç–æ–º.
	#  - 3. –î–æ–±–∞–≤–∏–ª–∏ –º–∏–Ω–∏–±–æ—Ç–∞. –í —Ç–∞–∫–æ–º —Å–ª—É—á–∞–µ, —Å–æ–±—ã—Ç–∏–µ –æ–± —ç—Ç–æ–º –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î.
	#
	# –î–ª—è –Ω–∞—á–∞–ª–∞, –æ–ø—Ä–µ–¥–µ–ª—è–µ–º, –¥–æ–±–∞–≤–∏–ª–∏ –ª–∏ –º–∏–Ω–∏–±–æ—Ç–∞ –∏–ª–∏ –Ω–µ—Ç.
	is_minibot = any([i for i in get_minibots().values() if i.id == event.new_chat_member.user.id])

	# –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–∏–ª –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –Ω–µ –º–∏–Ω–∏–±–æ—Ç–∞, —Ç–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ:
	if not event.new_chat_member.user.is_bot or not is_minibot:
		if group["UserJoinedWarning"]:
			return

		text = (
			"<b>ü´Ç –ì—Ä—É–ø–ø–∞-–¥–∏–∞–ª–æ–≥</b>\n"
			"\n"
			"–í—ã –¥–æ–±–∞–≤–∏–ª–∏ –∏–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –¥–∞–Ω–Ω—É—é –≥—Ä—É–ø–ø—É!\n"
			"–≠—Ç–æ –Ω–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ –±–æ—Ç–æ–º, –æ–¥–Ω–∞–∫–æ —Ç–∞–∫ –¥–µ–ª–∞—Ç—å <b>–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è</b>, –ø–æ—Å–∫–æ–ª—å–∫—É –¥—Ä—É–≥–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å –í–∞—à–∏ —Å–æ–æ–±—â–µ–Ω–∏—è, –∞ —Ç–∞–∫ –∂–µ –±–æ—Ç –º–æ–∂–µ—Ç –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –≤ —Å–ª—É—á–∞—è—Ö –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è ¬´—á—É–∂–∏—Ö¬ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –≥—Ä—É–ø–ø–µ.\n"
			"\n"
			f"‚ÑπÔ∏è –í—ã –º–æ–∂–µ—Ç–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –±–æ—Ç–∞ —Ç–∞–∫, —á—Ç–æ –±—ã —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏—Å—å –æ—Ç –í–∞—à–µ–≥–æ, –ª–∏–±–æ –æ—Ç –∏—Ö —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–º–µ–Ω–∏, –ª–∏–±–æ —á—Ç–æ –±—ã –∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å. –ó–∞–π–¥–∏—Ç–µ –≤ <a href=\"{utils.create_command_url('/s Services')}\">–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–∏—Å–æ–≤</a> –∏ –Ω–∞–π–¥–∏—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–≤–µ–¥–µ–Ω–∏—è –≤ —Ç–∞–∫–∏—Ö —Å–ª—É—á–∞—è—Ö."
		)

		if not is_minibot:
			minibots_str = "\n".join([f" ‚Ä¢ @{minibot}." for minibot in get_minibots().keys()])

			text = (
				"<b>ü´Ç –ì—Ä—É–ø–ø–∞-–¥–∏–∞–ª–æ–≥</b>\n"
				"\n"
				"–í—ã –¥–æ–±–∞–≤–∏–ª–∏ —Å—Ç–æ—Ä–æ–Ω–Ω–µ–≥–æ –±–æ—Ç–∞ –≤ –¥–∞–Ω–Ω—É—é –≥—Ä—É–ø–ø—É! –•–æ—Ç—è —ç—Ç–æ –∏ –Ω–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ –±–æ—Ç–æ–º, —Ç–∞–∫ –¥–µ–ª–∞—Ç—å <b>–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è</b>.\n"
				"–ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ —Ç–æ, —á—Ç–æ –¥–∞–∂–µ –ø—Ä–∏ –ø–æ–≤—ã—à–µ–Ω–∏–∏ –ø—Ä–∞–≤, <a href=\"https://core.telegram.org/bots/faq#why-doesn-39t-my-bot-see-messages-from-other-bots\">–¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π –í–∞–º–∏ –±–æ—Ç –Ω–µ —Å–º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç —á—É–∂–∏—Ö –±–æ—Ç–æ–≤</a>, –æ–Ω –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–µ—É–¥–æ–±—Å—Ç–≤–∞ –ø—Ä–∏ –æ–±—â–µ–Ω–∏–∏ —Å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–º –∏–∑ —Å–µ—Ä–≤–∏—Å–∞.\n"
				"\n"
				f"‚ÑπÔ∏è –í—ã –ø—ã—Ç–∞–ª–∏—Å—å –¥–æ–±–∞–≤–∏—Ç—å ¬´–º–∏–Ω–∏–±–æ—Ç–∞¬ª? –ï—Å–ª–∏ –¥–∞, —Ç–æ –í—ã –¥–æ–±–∞–≤–∏–ª–∏ –Ω–µ —Ç–æ–≥–æ –±–æ—Ç–∞. –í–æ—Ç —Å–ø–∏—Å–æ–∫ –º–∏–Ω–∏–±–æ—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã—Ö –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å:\n"
				f"{minibots_str}"
			)

		await bot.send_message(chat_id=event.chat.id, text=text, disable_web_page_preview=True)

		# –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ, —á—Ç–æ –º—ã –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
		group["UserJoinedWarning"] = True
		await group.save()

		return

	# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–∏–ª –º–∏–Ω–∏–±–æ—Ç–∞. –ù—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —ç—Ç–æ–º –≤ –ë–î.
	minibot_username = event.new_chat_member.user.username

	logger.debug(f"–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∏–Ω–∏–±–æ—Ç–∞ @{minibot_username} –≤ –≥—Ä—É–ø–ø—É \"{event.chat.full_name}\"")

	# –ß—Ç–æ –±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å —Ñ–ª—É–¥ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± —É—Å–ø–µ—à–Ω–æ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏, –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —ç—Ç–æ–º –ª–∏—à—å —Ä–∞–∑.
	first_add = False
	if event.chat.id not in _minibot_adds:
		_minibot_adds[event.chat.id] = []

		first_add = True

	_minibot_adds[event.chat.id].append(minibot_username)

	# –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –ø–µ—Ä–≤–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ, —Ç–æ –Ω–∏—á–µ–≥–æ –±–æ–ª—å—à–µ –Ω–µ –¥–µ–ª–∞–µ–º –∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º.
	if not first_add:
		return

	await asyncio.sleep(1)

	await bot.send_message(
		chat_id=event.chat.id,
		text=(
			"<b>ü´Ç –ì—Ä—É–ø–ø–∞-–¥–∏–∞–ª–æ–≥</b>\n"
			"\n"
			f"–ú–∏–Ω–∏–±–æ—Ç @{minibot_username} {('(–∏ –µ—â—ë ' + str(len(_minibot_adds[event.chat.id]) - 1) + ' –¥—Ä—É–≥–∏—Ö) ') if len(_minibot_adds[event.chat.id]) > 1 else ''}–±—ã–ª —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á—ë–Ω –∫ –¥–∞–Ω–Ω–æ–π –≥—Ä—É–ø–ø–µ! üéâ\n"
			"–ï—Å–ª–∏ –¥–∞–Ω–Ω–∞—è –≥—Ä—É–ø–ø–∞ Telegram —Å–≤—è–∑–∞–Ω–∞ —Å –±–µ—Å–µ–¥–æ–π —Å–µ—Ä–≤–∏—Å–∞, —Ç–æ Telehooper –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç —Ç–æ, —Å –∫–∞–∫–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –±–µ—Å–µ–¥—ã –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–≤—è–∑–∞–Ω –¥–∞–Ω–Ω—ã–π –º–∏–Ω–∏–±–æ—Ç.\n"
			"\n"
			"–î–∞–≤–∞—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –º–∏–Ω–∏–±–æ—Ç–∞–º –Ω–µ—Ç –Ω–∏–∫–∞–∫–æ–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.\n"
			"\n"
			"‚ÑπÔ∏è –í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –º–∏–Ω–∏–±–æ—Ç–æ–≤ –∏ –¥—Ä—É–≥—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–∞–Ω–Ω–æ–π –≥—Ä—É–ø–ø–µ –≤ –∫–æ–º–∞–Ω–¥–µ /this."
		)
	)

	group["Minibots"].extend(i for i in _minibot_adds[event.chat.id] if i not in group["Minibots"])
	await group.save()

	del _minibot_adds[event.chat.id]

@router.callback_query(F.data == "/this showAdminTips", F.message.as_("msg"))
async def show_platform_admin_steps_inline_handler(query: CallbackQuery, msg: Message, bot: Bot) -> None:
	"""
	Handler, –≤—ã–∑—ã–≤–∞–µ–º—ã–π, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ welcome-—Å–æ–æ–±—â–µ–Ω–∏–∏ –Ω–∞–∂–∞–ª –Ω–∞ –∫–Ω–æ–ø–∫—É —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π –ø–æ –≤—ã–¥–∞—á–µ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
	"""

	await TelehooperAPI.edit_or_resend_message(
		bot,
		text=(
			"<b>ü´Ç –ì—Ä—É–ø–ø–∞-–¥–∏–∞–ª–æ–≥</b>.\n"
			"\n"
			"–û—Ç–ª–∏—á–Ω–æ! –î–æ–±–∞–≤–∏–≤ –º–µ–Ω—è –≤ –≥—Ä—É–ø–ø—É, –í—ã —Å–º–æ–∂–µ—Ç–µ –≤—ã–±—Ä–∞—Ç—å –Ω—É–∂–Ω—ã–π –í–∞–º –¥–∏–∞–ª–æ–≥ –∏–∑ –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞.\n"
			"\n"
			"–ß—Ç–æ –±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å, –í–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ <b>–≤—ã–¥–∞—Ç—å –º–Ω–µ –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</b>. –í—ã–¥–∞–≤ –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –º—ã —Å–º–æ–∂–µ–º –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤—ã–±–æ—Ä –¥–∏–∞–ª–æ–≥–∞.\n"
			"–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –≤—ã–¥–∞—á–µ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º –æ–ø–∏—Å–∞–Ω—ã –Ω–∏–∂–µ.\n"
			"\n"
			"Telegram Desktop:\n"
			" ‚Ä¢ –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É ¬´–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–æ–π¬ª.\n"
			" ‚Ä¢ –í—ã–±–µ—Ä–∏—Ç–µ –ø—É–Ω–∫—Ç ¬´–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã¬ª.\n"
			" ‚Ä¢ –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É ¬´–î–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞¬ª.\n"
			f" ‚Ä¢ –ù–∞–π–¥–∏—Ç–µ –±–æ—Ç–∞ @{utils.get_bot_username()}.\n"
			" ‚Ä¢ –†–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å—ë, –∫—Ä–æ–º–µ –ø—É–Ω–∫—Ç–∞ ¬´–ê–Ω–æ–Ω–∏–º–Ω–æ—Å—Ç—å¬ª.\n"
			"\n"
			"Android:\n"
			" ‚Ä¢ –û—Ç–∫—Ä–æ–π—Ç–µ —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≥—Ä—É–ø–ø—ã.\n"
			" ‚Ä¢ –ó–∞–∂–º–∏—Ç–µ –ø–∞–ª–µ—Ü –Ω–∞–¥ —ç—Ç–∏–º –±–æ—Ç–æ–º.\n"
			" ‚Ä¢ –†–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å—ë, –∫—Ä–æ–º–µ –ø—É–Ω–∫—Ç–∞ ¬´–ê–Ω–æ–Ω–∏–º–Ω–æ—Å—Ç—å¬ª.\n"
			"\n"
			"<i>‚è≥ –î–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤ –±–µ—Å–µ–¥–µ...</i>"
		),
		message_to_edit=msg,
		chat_id=msg.chat.id,
		query=query
	)

@router.my_chat_member(ChatMemberUpdatedFilter(member_status_changed=(RESTRICTED | MEMBER | KICKED) >> (ADMINISTRATOR | CREATOR)))
async def on_user_promoted_handler(event: ChatMemberUpdated, bot: Bot):
	"""
	Handler, –≤—ã–∑—ã–≤–∞–µ–º—ã–π, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–≤—ã—Å–∏–ª–∏ –≤ –≥—Ä—É–ø–ø–µ.
	"""

	# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–≤—ã—Å–∏–ª–∏ –∏–º–µ–Ω–Ω–æ –±–æ—Ç–∞.
	if event.new_chat_member.user.id != bot.id:
		return

	await asyncio.sleep(1)

	group = await get_group(event.chat)

	# –í –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö edge-case'–∞—Ö –≥—Ä—É–ø–ø–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –ë–î.
	if not group:
		return

	# –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ.
	#
	# –ï—Å–ª–∏ –≥—Ä—É–ø–ø–∞ –±—ã–ª–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –≤ —Å—É–ø–µ—Ä–≥—Ä—É–ø–ø—É, —Ç–æ –±–æ—Ç –Ω–µ —Å–º–æ–∂–µ—Ç –µ–≥–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å, –ø–æ—ç—Ç–æ–º—É –º—ã –µ–≥–æ –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏–º.
	try:
		await group_convert_message(bot, event.chat.id, event.from_user, group["StatusMessageID"], called_from_command=False)
	except:
		await group_convert_message(bot, event.chat.id, event.from_user, None, called_from_command=False)

@router.chat_member(ChatMemberUpdatedFilter(member_status_changed=(ADMINISTRATOR | CREATOR) >> (RESTRICTED | MEMBER)))
async def on_user_demotion_handler(event: ChatMemberUpdated, bot: Bot):
	"""
	Handler, –≤—ã–∑—ã–≤–∞–µ–º—ã–π, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≥—Ä—É–ø–ø–µ –ø–æ–Ω–∏–∑–∏–ª–∏.
	"""

	# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–Ω–∏–∑–∏–ª–∏ –∏–º–µ–Ω–Ω–æ –±–æ—Ç–∞.
	if event.new_chat_member.user.id != bot.id:
		return

	await asyncio.sleep(1)

	group = await get_group(event.chat)

	# –í –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö edge-case'–∞—Ö –≥—Ä—É–ø–ø–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –ë–î.
	if not group:
		return

	# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É –±–æ—Ç–∞ —Ä–∞–Ω–µ–µ –±—ã–ª–∏ –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
	if not group["AdminRights"]:
		return

	# –ó–∞–ø–æ–º–∏–Ω–∞–µ–º, —á—Ç–æ —É –±–æ—Ç–∞ —Ç–µ–ø–µ—Ä—å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∞.
	group["AdminRights"] = False
	await group.save()

	await bot.send_message(
		event.chat.id,
		(
			"<b>‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ —Ä–∞–±–æ—Ç–µ –±–æ—Ç–∞ –≤ —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ</b>.\n"
			"\n"
			"–ü–æ—Ö–æ–∂–µ, —á—Ç–æ –í—ã –ø–æ–Ω–∏–∑–∏–ª–∏ –±–æ—Ç–∞ Telehooper –≤ —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ. –ë–æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç—É, –æ–¥–Ω–∞–∫–æ –µ–≥–æ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞—Ä—É—à–µ–Ω–∞.\n"
			"\n"
			"–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤—ã–¥–∞—Ç—å –±–æ—Ç—É –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞, —á—Ç–æ –±—ã –æ–Ω –º–æ–≥ —Ä–∞–±–æ—Ç–∞—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–æ."
		)
	)

@router.chat_member(ChatMemberUpdatedFilter(member_status_changed=LEAVE_TRANSITION))
async def on_user_chat_kick_handler(event: ChatMemberUpdated, bot: Bot):
	"""
	Handler, –≤—ã–∑—ã–≤–∞–µ–º—ã–π, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–¥–∞–ª–∏–ª–∏ –∏–∑ –≥—Ä—É–ø–ø—ã.
	"""

	# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–Ω–∏–∑–∏–ª–∏ –∏–º–µ–Ω–Ω–æ –±–æ—Ç–∞.
	# TODO: –ï—Å–ª–∏ –∏–∑ –≥—Ä—É–ø–ø—ã –≤—ã—à–µ–ª –∏–º–µ–Ω–Ω–æ –≤–ª–∞–¥–µ–ª–µ—Ü, —Ç–æ –Ω–∞–ø–∏—Å–∞—Ç—å –µ–º—É –≤ –õ–° –æ–± —ç—Ç–æ–º, –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –≤–µ—Ä–Ω—É—Ç—å—Å—è, –≤ –∏–Ω–æ–º —Å–ª—É—á–∞–µ - —É–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É.
	if event.new_chat_member.user.id != bot.id:
		return

	await asyncio.sleep(1)

	# –ï—Å–ª–∏ –≥—Ä—É–ø–ø–∞ –Ω–µ –±—ã–ª–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –ë–î, —Ç–æ –∑–Ω–∞—á–∏—Ç —á—Ç–æ —É–¥–∞–ª—è—Ç—å –Ω–µ—á–µ–≥–æ.
	if not get_group(event.chat):
		return

	# –£–¥–∞–ª—è–µ–º –≥—Ä—É–ø–ø—É –∏–∑ –ë–î.
	await TelehooperAPI.delete_group_data(event.chat.id, fully_delete=True, bot=bot)

@router.message(F.migrate_to_chat_id)
async def group_to_supergroup_convert_handler(message: Message, bot: Bot):
	"""
	Handler –¥–ª—è —Å–æ–±—ã—Ç–∏—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ Telegram-–≥—Ä—É–ø–ø—ã –≤ —Å—É–ø–µ—Ä–≥—Ä—É–ø–ø—É.

	–ü—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤ —Å—É–ø–µ—Ä–≥—Ä—É–ø–ø—É Telegram –º–µ–Ω—è–µ—Ç ID –≥—Ä—É–ø–ø—ã.
	"""

	old_chat_id = message.chat.id
	new_chat_id = cast(int, message.migrate_to_chat_id)

	logger.debug(f"Telegram-–≥—Ä—É–ø–ø–∞ —Å ID {old_chat_id} –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–ª–∞—Å—å –≤ supergroup'—É —Å ID {new_chat_id}")

	new_chat = await bot.get_chat(new_chat_id)

	_supergroup_converts.append(old_chat_id)
	_supergroup_converts.append(new_chat_id)

	db = await get_db()

	# –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∞—Å—Å–æ—Ü–∏–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å –¥–∞–Ω–Ω–æ–π –≥—Ä—É–ø–ø–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.
	group_owner = None
	async for user in db.docs(prefix="user_"):
		if old_chat_id not in user["Groups"]:
			continue

		group_owner = user

	if not group_owner:
		logger.debug(f"–í–ª–∞–¥–µ–ª–µ—Ü –≥—Ä—É–ø–ø—ã, –∫–æ—Ç–æ—Ä–∞—è –±—ã–ª–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –≤ —Å—É–ø–µ—Ä–≥—Ä—É–ø–ø—É –Ω–µ –±—ã–ª –Ω–∞–π–¥–µ–Ω. –°—Ç–∞—Ä—ã–π ID: {old_chat_id}, –Ω–æ–≤—ã–π: {new_chat_id}")

	# –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å—Ç–∞—Ä—É—é –≥—Ä—É–ø–ø—É, –∏ —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é —Å –Ω–æ–≤—ã–º ID –∏ –ø—Ä–æ—á–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏.
	group_old = await get_group(message.chat)
	if not group_old:
		return

	old_group_data = group_old._data.copy()

	del old_group_data["_id"]
	del old_group_data["_rev"]

	old_group_data["ID"] = new_chat_id
	old_group_data["LastActivityAt"] = utils.get_timestamp()

	# –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –≥—Ä—É–ø–ø—ã –∏–∑ –ë–î.
	group_new = await db.create(f"group_{new_chat_id}", exists_ok=False, data=old_group_data)

	# –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—É—é –≥—Ä—É–ø–ø—É.
	await group_new.save()

	# –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –æ–±—ä–µ–∫—Ç –≥—Ä—É–ø–ø—ã –∏–∑ –ë–î.
	await group_old.delete()

	# –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —É –≤–ª–∞–¥–µ–ª—å—Ü–∞ –≥—Ä—É–ø–ø—ã.
	if group_owner:
		group_owner["Groups"].remove(old_chat_id)
		group_owner["Groups"].append(new_chat_id)

		if "VK" in group_owner["Connections"]:
			for group in group_owner["Connections"]["VK"]["OwnedGroups"].values():
				if group["GroupID"] != old_chat_id:
					continue

				group["GroupID"] = new_chat_id

		# –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —É –≤–ª–∞–¥–µ–ª—å—Ü–∞ –≥—Ä—É–ø–ø—ã.
		await group_owner.save()

	# –§–∏–∫—Å–∏–º –≤—Å–µ subgroup'—ã, —á—Ç–æ –±—ã –≤ –Ω–∏—Ö –±—ã–ª –Ω–æ–≤—ã–π ID.
	for subgroup in TelehooperAPI.get_all_subgroups():
		if subgroup.parent.chat.id != old_chat_id:
			continue

		subgroup.parent.chat = new_chat
